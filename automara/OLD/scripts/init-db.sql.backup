-- Automara Database Initialization Script
-- Creates master tables and encryption functions

-- Enable required extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- Master tenants table (not in a schema - shared across all)
CREATE TABLE IF NOT EXISTS public.tenants (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(255) NOT NULL,
    subdomain VARCHAR(100) UNIQUE NOT NULL,
    schema_name VARCHAR(63) UNIQUE NOT NULL,
    status VARCHAR(50) DEFAULT 'active',
    stripe_customer_id VARCHAR(255),
    stripe_subscription_id VARCHAR(255),
    subscription_status VARCHAR(50),
    subscription_plan VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    metadata JSONB DEFAULT '{}'
);

-- Master users table for authentication
CREATE TABLE IF NOT EXISTS public.users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    tenant_id UUID NOT NULL REFERENCES public.tenants(id) ON DELETE CASCADE,
    email VARCHAR(255) UNIQUE NOT NULL,
    supertokens_user_id VARCHAR(255) UNIQUE NOT NULL,
    role VARCHAR(50) DEFAULT 'user',
    status VARCHAR(50) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP,
    metadata JSONB DEFAULT '{}'
);

-- Encryption/Decryption functions using AES
-- Note: The key should be stored securely and passed from environment
CREATE OR REPLACE FUNCTION encrypt_field(data TEXT, key TEXT)
RETURNS TEXT AS $$
BEGIN
    RETURN encode(
        pgp_sym_encrypt(data, key, 'cipher-algo=aes256'),
        'base64'
    );
END;
$$ LANGUAGE plpgsql IMMUTABLE;

CREATE OR REPLACE FUNCTION decrypt_field(encrypted_data TEXT, key TEXT)
RETURNS TEXT AS $$
BEGIN
    RETURN pgp_sym_decrypt(
        decode(encrypted_data, 'base64'),
        key
    );
EXCEPTION
    WHEN OTHERS THEN
        RETURN NULL;
END;
$$ LANGUAGE plpgsql IMMUTABLE;

-- Function to create a new tenant schema
CREATE OR REPLACE FUNCTION create_tenant_schema(schema_name TEXT)
RETURNS VOID AS $$
BEGIN
    -- Create schema
    EXECUTE format('CREATE SCHEMA IF NOT EXISTS %I', schema_name);
    
    -- Set search path
    EXECUTE format('SET search_path TO %I', schema_name);
    
    -- Create tenant-specific tables
    
    -- API Keys table (encrypted)
    EXECUTE format('
        CREATE TABLE IF NOT EXISTS %I.api_keys (
            id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
            service_name VARCHAR(100) NOT NULL,
            key_name VARCHAR(255) NOT NULL,
            encrypted_key TEXT NOT NULL,
            encrypted_secret TEXT,
            is_active BOOLEAN DEFAULT true,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            last_used TIMESTAMP,
            metadata JSONB DEFAULT ''{}''
        )', schema_name);
    
    -- Workflows table
    EXECUTE format('
        CREATE TABLE IF NOT EXISTS %I.workflows (
            id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
            n8n_workflow_id VARCHAR(255) UNIQUE NOT NULL,
            workflow_type VARCHAR(100) NOT NULL,
            name VARCHAR(255) NOT NULL,
            description TEXT,
            webhook_url TEXT,
            is_active BOOLEAN DEFAULT false,
            configuration JSONB DEFAULT ''{}''::jsonb,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            last_executed TIMESTAMP,
            execution_count INTEGER DEFAULT 0
        )', schema_name);
    
    -- Workflow executions log
    EXECUTE format('
        CREATE TABLE IF NOT EXISTS %I.workflow_executions (
            id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
            workflow_id UUID REFERENCES %I.workflows(id) ON DELETE CASCADE,
            n8n_execution_id VARCHAR(255),
            status VARCHAR(50),
            started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            finished_at TIMESTAMP,
            error_message TEXT,
            input_data JSONB,
            output_data JSONB
        )', schema_name, schema_name);
    
    -- M365 configurations
    EXECUTE format('
        CREATE TABLE IF NOT EXISTS %I.m365_configs (
            id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
            tenant_id VARCHAR(255) NOT NULL,
            encrypted_client_id TEXT NOT NULL,
            encrypted_client_secret TEXT NOT NULL,
            encrypted_tenant_id TEXT NOT NULL,
            is_active BOOLEAN DEFAULT true,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )', schema_name);
    
    -- Audit logs
    EXECUTE format('
        CREATE TABLE IF NOT EXISTS %I.audit_logs (
            id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
            user_id UUID,
            action VARCHAR(100) NOT NULL,
            resource_type VARCHAR(100),
            resource_id UUID,
            ip_address INET,
            user_agent TEXT,
            changes JSONB,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )', schema_name);
    
    -- Create indexes
    EXECUTE format('CREATE INDEX IF NOT EXISTS idx_api_keys_service ON %I.api_keys(service_name)', schema_name);
    EXECUTE format('CREATE INDEX IF NOT EXISTS idx_workflows_type ON %I.workflows(workflow_type)', schema_name);
    EXECUTE format('CREATE INDEX IF NOT EXISTS idx_executions_workflow ON %I.workflow_executions(workflow_id)', schema_name);
    EXECUTE format('CREATE INDEX IF NOT EXISTS idx_audit_user ON %I.audit_logs(user_id)', schema_name);
    
END;
$$ LANGUAGE plpgsql;

-- Create indexes on master tables
CREATE INDEX IF NOT EXISTS idx_tenants_subdomain ON public.tenants(subdomain);
CREATE INDEX IF NOT EXISTS idx_tenants_status ON public.tenants(status);
CREATE INDEX IF NOT EXISTS idx_users_email ON public.users(email);
CREATE INDEX IF NOT EXISTS idx_users_tenant ON public.users(tenant_id);

-- Grant necessary permissions
GRANT USAGE ON SCHEMA public TO automara;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO automara;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO automara;
